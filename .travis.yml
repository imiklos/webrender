dist: trusty
language: rust

addons:
  apt:
    sources:
      - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-3.9 main'
        keyurl: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
      - sourceline: 'ppa:jonathonf/python-2.7'
    packages:
      - libgl1-mesa-dev
      - llvm-3.9-dev
      - libedit-dev
      - python

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export LLVM_CONFIG=/usr/lib/llvm-3.9/bin/llvm-config; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install zlib; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export PKG_CONFIG_PATH="/usr/local/opt/zlib/lib/pkgconfig:$PKG_CONFIG_PATH"; fi
  - pip install virtualenv
  - virtualenv ../venv
  - source ../venv/bin/activate
  - python --version
  - pip install mako voluptuous PyYAML servo-tidy

env:
  - RUST_BACKTRACE=1 RUSTFLAGS='--deny warnings'

matrix:
  include:
    - name: "Debug Test"
      os: linux
      script:
        - ci-scripts/linux-debug-tests.sh
      rust: 1.31.0

    - name: "Release Build"
      os: linux
      script:
        - cd wrench && cargo build --release
      rust: 1.31.0

    - name: "Release Test"
      os: linux
      script:
        - cd wrench && python script/headless.py reftest
      rust: 1.31.0

    - name: "Debug Test"
      os: osx
      rust: 1.31.0

    - name: "Release Build"
      os: osx
      rust: 1.31.0

    - name: "Release Test"
      os: osx
      script:
        - cd wrench && python script/headless.py reftest
      rust: 1.31.0

    - name: "Debug Test"
      os: linux
      script:
        - ci-scripts/linux-debug-tests.sh
        - cd webrender && cargo bench --verbose
      rust: nightly

    - name: "Release Build"
      os: linux
      script:
        - cd wrench && cargo build --release
        - cd webrender && cargo bench --verbose
      rust: nightly

    - name: "Release Test"
      os: linux
      script:
        - cd wrench && python script/headless.py reftest
        - cd webrender && cargo bench --verbose
      rust: nightly

    - name: "Debug Test"
      os: osx
      script:
        - ci-scripts/linux-debug-tests.sh
        - cd webrender && cargo bench --verbose
      rust: nightly

    - name: "Release Build"
      os: osx
      script:
        - cd wrench && cargo build --release
        - cd webrender && cargo bench --verbose
      rust: nightly

    - name: "Release Test"
      os: osx
      script:
        - cd wrench && python script/headless.py reftest
        - cd webrender && cargo bench --verbose
      rust: nightly

  fast_finish: true
  allow_failures:
   - rust: nightly
